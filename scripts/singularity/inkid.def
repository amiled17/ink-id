Bootstrap: library
From: ubuntu:16.04

%labels
  MAINTAINER Stephen Parsons <stephen.parsons@uky.edu>, Mami Hayashida <mami.hayashida@uky.edu>
  VERSION 0.1
  OS Ubuntu 16.04

%files
  /tmp/ink-id /usr/local/dri/ink-id

%post
  # Give read/write access in ink-id (so it can later be edited using a persistent overlay)
  chmod --recursive a+rw /usr/local/dri/ink-id
  # Basic installs
  apt update
  apt install -y git nano
  # Store git credentials for up to an hour (in overlay, not container) for convenience
  git config --global credential.helper cache
  git config --global credential.helper 'cache --timeout=3600'
  # Required to make python3.7 available
  apt install -y software-properties-common
  add-apt-repository -y ppa:deadsnakes/ppa
  apt update
  # Python installs
  apt install -y python3.7-dev python3-pip
  pip3 install --upgrade pip
  pip install --upgrade virtualenv
  # Create a virtualenv for this project
  virtualenv --python=python3.7 /usr/local/dri/env-inkid
  # Activate virtualenv
  . /usr/local/dri/env-inkid/bin/activate
  # Remove locally installed inkid from requirements file, we want to install that separately
  sed -i '/ink-id.git/d' /usr/local/dri/ink-id/requirements.txt
  # Install the exact versions of all of the dependencies
  pip install --requirement /usr/local/dri/ink-id/requirements.txt
  # Now install inkid
  pip install --editable /usr/local/dri/ink-id

%runscript
  if [ $# -lt 1 ]; then
      echo "Usage: ./container <command>"
      exit 1
  fi

  . /usr/local/dri/env-inkid/bin/activate
  exec "$@"

%help
  This container provides an environment for running inkid.

  Building the container:
    - Prerequisite: the ink-id git repository must exist at /tmp/ink-id on the host machine before building the container. Https is recommended so that it can be manipulated after container creation using your username and password instead of needing ssh keys on the container: `git clone https://code.cs.uky.edu/seales-research/ink-id.git /tmp/ink-id`
    - You may check out a different branch or make changes if desired, but this can all be done after the container is created.
    - Build as usual, for example: sudo singularity build inkid.sif inkid.def

  Usage:
    - Any script or shell usage should first source the virtualenv: `. /usr/local/dri/env-inkid/bin/activate`
    - It is possible to use an overlay to allow one to check out another branch, pull recent changes, or make local edits to ink-id code: `dd if=/dev/zero of=inkid.overlay bs=1M count=500 && mkfs.ext3 inkid.overlay; singularity shell --overlay inkid.overlay inkid.sif` (see Singularity documentation on persistent overlays). If the overlay directory is deleted or not specified when using the container, the changes will be gone and the checkout of ink-id built into the container will be present.

  This container is intended to be built once, and used with many checkouts of inkid code. Only when the dependencies change does the container need rebuilding.
