Bootstrap: library
From: ubuntu:18.04


%files
  # Copying git credentials from a local file
  <full path to the local credentials file>   /login.txt


%post
  # To compensate for the APT problem with the ubuntu 18.04 image
  # This may not be necessary once the image is corrected

  echo "deb http://us.archive.ubuntu.com/ubuntu/ bionic main restricted
  deb http://us.archive.ubuntu.com/ubuntu/ bionic-updates main restricted
  deb http://us.archive.ubuntu.com/ubuntu/ bionic universe
  deb http://us.archive.ubuntu.com/ubuntu/ bionic-updates universe
  deb http://us.archive.ubuntu.com/ubuntu/ bionic multiverse
  deb http://us.archive.ubuntu.com/ubuntu/ bionic-updates multiverse
  deb http://us.archive.ubuntu.com/ubuntu/ bionic-backports main restricted universe multiverse
  deb http://security.ubuntu.com/ubuntu bionic-security main restricted
  deb http://security.ubuntu.com/ubuntu bionic-security universe
  deb http://security.ubuntu.com/ubuntu bionic-security multiverse" >> /etc/apt/sources.list;

  apt-get update
  DEBIAN_FRONTEND=noninteractive apt-get install -y python3-dev python3-pip wget git-all

  pip3 install -U virtualenv
  virtualenv -p python3 tensorflow

  . /tensorflow/bin/activate

  pip install --upgrade pip
  pip install --upgrade tensorflow
  pip install --upgrade Cython

  # Retrieve git login information
  USERNAME=`sed -n 1p /login.txt`
  PASSWORD=`sed -n 2p /login.txt`
  BRANCH=`sed -n 3p /login.txt`

  git clone https://${USERNAME}:${PASSWORD}@code.cs.uky.edu/seales-research/ink-id.git 

  # If there is a specified branch, switch to it. (Default is 'master')
  if [ -n "${BRANCH}" ]
  then
    cd ./ink-id/
    git checkout ${BRANCH}
    cd ..
  fi

  # Install ink-id
  pip install -e ./ink-id/.

  # Remove the git login-credential file from the container
  rm /login.txt

%runscript
  if [ $# -lt 1 ]; then
      echo "Usage: ./container RUN COMMAND"
      exit 1
  fi
  
  . /tensorflow/bin/activate
  exec "$@"  

%test
  . /tensorflow/bin/activate
  inkid-train-and-predict -h

%labels
  Maintainer Mami Hayashida <mami.hayashida@uky.edu>
  Version v.0.2

%help
  This is a Singularity container for testing Ink-id software using the CPU version
  of tensorflow. Inside the container, there is a virtuaenv environment with all the 
  necessary dependencies as well as the ink-id package pre-installed from the time of the 
  container-build.

  Run scripts as shown below: 
  	singularity run inkid-cpu.sif inkid-train-and-predict <args>
  	singularity run python <python_script>.py <args>
 
  To use singularity shell, remember to activate the virtualenv environment first
        . /tensorflow/bin/activate
  
  login.txt must contain the following lines.  The third line is optional.
  <login name>
  <login password>
  <branch name>   (optional)

   
